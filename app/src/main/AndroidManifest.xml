<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android">

    <!-- ============================================ -->
    <!-- ANDROID 11+ PACKAGE QUERIES (for URL opening) -->
    <!-- Allows app to find browsers and other apps -->
    <!-- ============================================ -->
    <queries>
        <!-- Browser apps that can handle http/https URLs -->
        <intent>
            <action android:name="android.intent.action.VIEW" />
            <data android:scheme="http" />
        </intent>
        <intent>
            <action android:name="android.intent.action.VIEW" />
            <data android:scheme="https" />
        </intent>
        <!-- Activity manager -->
        <intent>
            <action android:name="android.intent.action.MAIN" />
        </intent>
        <!-- Common browsers explicitly -->
        <package android:name="com.android.chrome" />
        <package android:name="com.sec.android.app.sbrowser" />
        <package android:name="org.mozilla.firefox" />
        <package android:name="com.opera.browser" />
        <package android:name="com.brave.browser" />
    </queries>

    <!-- ============================================ -->
    <!-- BASIC PERMISSIONS -->
    <!-- ============================================ -->
    <uses-permission android:name="android.permission.INTERNET" />
    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
    <uses-permission android:name="android.permission.WAKE_LOCK" />
    <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />
    <uses-permission android:name="android.permission.FOREGROUND_SERVICE_SPECIAL_USE" />
    <uses-permission android:name="android.permission.FOREGROUND_SERVICE_DATA_SYNC" />

    <!-- ============================================ -->
    <!-- CRITICAL: SYSTEM_ALERT_WINDOW (Draw over other apps) -->
    <!-- Required for opening URLs from shell/background context -->
    <!-- Without this, Android 10+ blocks background activity starts -->
    <!-- ============================================ -->
    <uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW" />

    <!-- ============================================ -->
    <!-- TERMUX API - CLIPBOARD & NOTIFICATIONS -->
    <!-- ============================================ -->
    <uses-permission android:name="android.permission.VIBRATE" />
    <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />
    <uses-permission android:name="android.permission.SET_WALLPAPER" />
    <uses-permission android:name="android.permission.SET_WALLPAPER_HINTS" />
    <uses-permission android:name="android.permission.ACCESS_NOTIFICATION_POLICY" />
    <uses-permission android:name="android.permission.EXPAND_STATUS_BAR" />

    <!-- ============================================ -->
    <!-- TERMUX API - STORAGE -->
    <!-- ============================================ -->
    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />
    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />
    <uses-permission android:name="android.permission.MANAGE_EXTERNAL_STORAGE" />
    <uses-permission android:name="android.permission.DOWNLOAD_WITHOUT_NOTIFICATION" />
    <!-- Android 13+ granular media permissions -->
    <uses-permission android:name="android.permission.READ_MEDIA_IMAGES" />
    <uses-permission android:name="android.permission.READ_MEDIA_VIDEO" />
    <uses-permission android:name="android.permission.READ_MEDIA_AUDIO" />

    <!-- ============================================ -->
    <!-- TERMUX API - NETWORK & WIFI -->
    <!-- ============================================ -->
    <uses-permission android:name="android.permission.ACCESS_WIFI_STATE" />
    <uses-permission android:name="android.permission.CHANGE_WIFI_STATE" />
    <uses-permission android:name="android.permission.CHANGE_NETWORK_STATE" />
    <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
    <uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />
    <uses-permission android:name="android.permission.ACCESS_BACKGROUND_LOCATION" />

    <!-- ============================================ -->
    <!-- TERMUX API - BLUETOOTH -->
    <!-- ============================================ -->
    <uses-permission android:name="android.permission.BLUETOOTH" />
    <uses-permission android:name="android.permission.BLUETOOTH_ADMIN" />
    <!-- Android 12+ Bluetooth permissions -->
    <uses-permission android:name="android.permission.BLUETOOTH_CONNECT" />
    <uses-permission android:name="android.permission.BLUETOOTH_SCAN" />
    <uses-permission android:name="android.permission.BLUETOOTH_ADVERTISE" />

    <!-- ============================================ -->
    <!-- TERMUX API - CAMERA & MEDIA -->
    <!-- ============================================ -->
    <uses-permission android:name="android.permission.CAMERA" />
    <uses-permission android:name="android.permission.RECORD_AUDIO" />
    <uses-permission android:name="android.permission.MODIFY_AUDIO_SETTINGS" />
    <uses-permission android:name="android.permission.FLASHLIGHT" />

    <!-- ============================================ -->
    <!-- TERMUX API - TELEPHONY & SMS -->
    <!-- ============================================ -->
    <uses-permission android:name="android.permission.READ_PHONE_STATE" />
    <uses-permission android:name="android.permission.READ_PHONE_NUMBERS" />
    <uses-permission android:name="android.permission.CALL_PHONE" />
    <uses-permission android:name="android.permission.ANSWER_PHONE_CALLS" />
    <uses-permission android:name="android.permission.READ_CALL_LOG" />
    <uses-permission android:name="android.permission.WRITE_CALL_LOG" />
    <uses-permission android:name="android.permission.ADD_VOICEMAIL" />
    <uses-permission android:name="android.permission.USE_SIP" />
    <uses-permission android:name="android.permission.PROCESS_OUTGOING_CALLS" />
    <uses-permission android:name="android.permission.READ_SMS" />
    <uses-permission android:name="android.permission.SEND_SMS" />
    <uses-permission android:name="android.permission.RECEIVE_SMS" />
    <uses-permission android:name="android.permission.RECEIVE_MMS" />
    <uses-permission android:name="android.permission.RECEIVE_WAP_PUSH" />

    <!-- ============================================ -->
    <!-- TERMUX API - CONTACTS & CALENDAR -->
    <!-- ============================================ -->
    <uses-permission android:name="android.permission.READ_CONTACTS" />
    <uses-permission android:name="android.permission.WRITE_CONTACTS" />
    <uses-permission android:name="android.permission.GET_ACCOUNTS" />
    <uses-permission android:name="android.permission.READ_CALENDAR" />
    <uses-permission android:name="android.permission.WRITE_CALENDAR" />
    <uses-permission android:name="android.permission.READ_SYNC_SETTINGS" />
    <uses-permission android:name="android.permission.WRITE_SYNC_SETTINGS" />

    <!-- ============================================ -->
    <!-- TERMUX API - SENSORS & BIOMETRIC -->
    <!-- ============================================ -->
    <uses-permission android:name="android.permission.BODY_SENSORS" />
    <uses-permission android:name="android.permission.BODY_SENSORS_BACKGROUND" />
    <uses-permission android:name="android.permission.HIGH_SAMPLING_RATE_SENSORS" />
    <uses-permission android:name="android.permission.ACTIVITY_RECOGNITION" />
    <uses-permission android:name="android.permission.USE_BIOMETRIC" />
    <uses-permission android:name="android.permission.USE_FINGERPRINT" />
    <uses-permission android:name="android.permission.TRANSMIT_IR" />

    <!-- ============================================ -->
    <!-- TERMUX API - USB -->
    <!-- ============================================ -->
    <uses-permission android:name="android.permission.USB_PERMISSION" />

    <!-- ============================================ -->
    <!-- TERMUX API - NFC -->
    <!-- ============================================ -->
    <uses-permission android:name="android.permission.NFC" />
    <uses-permission android:name="android.permission.NFC_TRANSACTION_EVENT" />
    <uses-permission android:name="android.permission.NFC_PREFERRED_PAYMENT_INFO" />

    <!-- ============================================ -->
    <!-- TERMUX API - SYSTEM -->
    <!-- ============================================ -->
    <uses-permission android:name="android.permission.REQUEST_IGNORE_BATTERY_OPTIMIZATIONS" />
    <uses-permission android:name="android.permission.RECEIVE_BOOT_COMPLETED" />
    <uses-permission android:name="android.permission.SCHEDULE_EXACT_ALARM" />
    <uses-permission android:name="android.permission.USE_EXACT_ALARM" />
    <uses-permission android:name="android.permission.REQUEST_INSTALL_PACKAGES" />
    <uses-permission android:name="android.permission.REQUEST_DELETE_PACKAGES" />
    <uses-permission android:name="android.permission.PACKAGE_USAGE_STATS" />
    <uses-permission android:name="android.permission.REORDER_TASKS" />
    <uses-permission android:name="android.permission.KILL_BACKGROUND_PROCESSES" />
    <uses-permission android:name="android.permission.WRITE_SETTINGS" />
    <uses-permission android:name="android.permission.BROADCAST_STICKY" />
    <uses-permission android:name="com.android.alarm.permission.SET_ALARM" />

    <!-- ============================================ -->
    <!-- ANDROID 11+ PACKAGE VISIBILITY (CRITICAL!) -->
    <!-- Required to find browser apps for URL opening -->
    <!-- Without this, am start can't find handlers -->
    <!-- ============================================ -->
    <uses-permission android:name="android.permission.QUERY_ALL_PACKAGES" />

    <!-- ============================================ -->
    <!-- CUSTOM PERMISSION (Like Real Termux) -->
    <!-- ============================================ -->
    <permission
        android:name="com.termux.permission.RUN_COMMAND"
        android:label="Run commands in MobileCLI"
        android:description="@string/run_command_permission_description"
        android:protectionLevel="dangerous" />

    <!-- ============================================ -->
    <!-- HARDWARE FEATURES (all optional) -->
    <!-- ============================================ -->
    <uses-feature android:name="android.hardware.touchscreen" android:required="false" />
    <uses-feature android:name="android.software.leanback" android:required="false" />
    <uses-feature android:name="android.hardware.camera" android:required="false" />
    <uses-feature android:name="android.hardware.camera.flash" android:required="false" />
    <uses-feature android:name="android.hardware.camera.autofocus" android:required="false" />
    <uses-feature android:name="android.hardware.microphone" android:required="false" />
    <uses-feature android:name="android.hardware.location" android:required="false" />
    <uses-feature android:name="android.hardware.location.gps" android:required="false" />
    <uses-feature android:name="android.hardware.telephony" android:required="false" />
    <uses-feature android:name="android.hardware.sensor.accelerometer" android:required="false" />
    <uses-feature android:name="android.hardware.sensor.gyroscope" android:required="false" />
    <uses-feature android:name="android.hardware.sensor.light" android:required="false" />
    <uses-feature android:name="android.hardware.sensor.proximity" android:required="false" />
    <uses-feature android:name="android.hardware.fingerprint" android:required="false" />
    <uses-feature android:name="android.hardware.consumerir" android:required="false" />
    <uses-feature android:name="android.hardware.usb.host" android:required="false" />
    <uses-feature android:name="android.hardware.nfc" android:required="false" />

    <application
        android:name=".TermuxApplication"
        android:allowBackup="false"
        android:icon="@drawable/ic_launcher"
        android:label="@string/app_name"
        android:roundIcon="@drawable/ic_launcher"
        android:supportsRtl="false"
        android:theme="@style/Theme.MobileCLI"
        android:extractNativeLibs="true"
        android:networkSecurityConfig="@xml/network_security_config">

        <!-- ============================================ -->
        <!-- AUTHENTICATION ACTIVITIES -->
        <!-- ============================================ -->

        <!-- Splash Activity - Entry point, checks auth status -->
        <activity
            android:name=".auth.SplashActivity"
            android:exported="true"
            android:theme="@style/Theme.MobileCLI.NoActionBar">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
            <!-- For Android TV / Leanback -->
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LEANBACK_LAUNCHER" />
            </intent-filter>
        </activity>

        <!-- Login Activity - Email/OAuth authentication -->
        <activity
            android:name=".auth.LoginActivity"
            android:exported="true"
            android:launchMode="singleTask"
            android:theme="@style/Theme.MobileCLI.NoActionBar"
            android:windowSoftInputMode="adjustResize">
            <!-- Deep link for OAuth callback -->
            <intent-filter>
                <action android:name="android.intent.action.VIEW" />
                <category android:name="android.intent.category.DEFAULT" />
                <category android:name="android.intent.category.BROWSABLE" />
                <data
                    android:scheme="com.termux"
                    android:host="login-callback" />
            </intent-filter>
        </activity>

        <!-- Paywall Activity - Subscription/trial flow -->
        <activity
            android:name=".auth.PaywallActivity"
            android:exported="true"
            android:launchMode="singleTask"
            android:theme="@style/Theme.MobileCLI.NoActionBar">
            <!-- Deep link for PayPal payment success return -->
            <intent-filter>
                <action android:name="android.intent.action.VIEW" />
                <category android:name="android.intent.category.DEFAULT" />
                <category android:name="android.intent.category.BROWSABLE" />
                <data
                    android:scheme="com.termux"
                    android:host="payment-success" />
            </intent-filter>
            <!-- HTTPS App Link for payment success (requires assetlinks.json on server) -->
            <intent-filter android:autoVerify="true">
                <action android:name="android.intent.action.VIEW" />
                <category android:name="android.intent.category.DEFAULT" />
                <category android:name="android.intent.category.BROWSABLE" />
                <data
                    android:scheme="https"
                    android:host="www.mobilecli.com"
                    android:pathPrefix="/success" />
            </intent-filter>
        </activity>

        <!-- Account Activity - Profile, subscription management, logout -->
        <activity
            android:name=".auth.AccountActivity"
            android:exported="false"
            android:theme="@style/Theme.MobileCLI"
            android:parentActivityName=".MainActivity" />

        <!-- ============================================ -->
        <!-- MAIN ACTIVITIES -->
        <!-- ============================================ -->

        <!-- Setup Wizard - First launch experience (3-stage flow) -->
        <activity
            android:name=".SetupWizard"
            android:exported="false"
            android:theme="@style/Theme.MobileCLI.NoActionBar"
            android:configChanges="orientation|screenSize|screenLayout|smallestScreenSize|density|keyboard|keyboardHidden" />

        <!-- Main Terminal Activity - Full configChanges like real Termux -->
        <activity
            android:name=".MainActivity"
            android:exported="true"
            android:launchMode="singleTask"
            android:windowSoftInputMode="adjustResize"
            android:resizeableActivity="true"
            android:configChanges="mcc|mnc|locale|touchscreen|keyboard|keyboardHidden|navigation|screenLayout|fontScale|uiMode|orientation|screenSize|smallestScreenSize|density">
        </activity>

        <!-- Settings Activity -->
        <activity
            android:name=".activities.SettingsActivity"
            android:exported="false"
            android:theme="@style/Theme.MobileCLI.NoActionBar"
            android:parentActivityName=".MainActivity"
            android:configChanges="orientation|screenSize|screenLayout|smallestScreenSize|keyboard|keyboardHidden">
        </activity>

        <!-- URL Handler Activity - Opens URLs from shell with proper Activity context -->
        <activity
            android:name=".TermuxUrlHandlerActivity"
            android:exported="true"
            android:theme="@android:style/Theme.NoDisplay"
            android:excludeFromRecents="true"
            android:noHistory="true">
            <intent-filter>
                <action android:name="com.termux.OPEN_URL" />
                <category android:name="android.intent.category.DEFAULT" />
            </intent-filter>
        </activity>

        <!-- AM Dispatcher Activity - Handles am start commands from terminal -->
        <!-- Solves Android 10+ background activity start restriction -->
        <activity
            android:name=".TermuxAmDispatcherActivity"
            android:exported="true"
            android:theme="@android:style/Theme.NoDisplay"
            android:excludeFromRecents="true"
            android:noHistory="true">
            <intent-filter>
                <action android:name="com.termux.AM_DISPATCH" />
                <category android:name="android.intent.category.DEFAULT" />
            </intent-filter>
        </activity>

        <!-- File Receiver Activity (like real Termux) -->
        <activity
            android:name=".filepicker.TermuxFileReceiverActivity"
            android:exported="true"
            android:taskAffinity="com.termux.filereceiver"
            android:excludeFromRecents="true"
            android:noHistory="true"
            android:resizeableActivity="true">
            <intent-filter>
                <action android:name="android.intent.action.SEND" />
                <category android:name="android.intent.category.DEFAULT" />
                <data android:mimeType="application/*" />
                <data android:mimeType="audio/*" />
                <data android:mimeType="image/*" />
                <data android:mimeType="message/*" />
                <data android:mimeType="multipart/*" />
                <data android:mimeType="text/*" />
                <data android:mimeType="video/*" />
            </intent-filter>
            <intent-filter>
                <action android:name="android.intent.action.VIEW" />
                <category android:name="android.intent.category.DEFAULT" />
                <data android:mimeType="application/*" />
                <data android:mimeType="audio/*" />
                <data android:mimeType="image/*" />
                <data android:mimeType="text/*" />
                <data android:mimeType="video/*" />
            </intent-filter>
        </activity>

        <!-- ============================================ -->
        <!-- CONTENT PROVIDERS -->
        <!-- ============================================ -->

        <!-- Documents Provider (SAF) for file access from other apps -->
        <provider
            android:name=".filepicker.TermuxDocumentsProvider"
            android:authorities="com.termux.documents"
            android:exported="true"
            android:grantUriPermissions="true"
            android:permission="android.permission.MANAGE_DOCUMENTS">
            <intent-filter>
                <action android:name="android.content.action.DOCUMENTS_PROVIDER" />
            </intent-filter>
        </provider>

        <!-- File Provider for sharing files -->
        <provider
            android:name=".app.TermuxOpenReceiver$ContentProvider"
            android:authorities="com.termux.files"
            android:exported="true"
            android:grantUriPermissions="true"
            android:permission="com.termux.permission.RUN_COMMAND">
        </provider>

        <!-- ============================================ -->
        <!-- BROADCAST RECEIVERS -->
        <!-- ============================================ -->

        <!-- Termux API Receiver - v5.0.0: Removed permission requirement -->
        <!-- Shell scripts don't have RUN_COMMAND permission, so the permission -->
        <!-- attribute was blocking ALL broadcasts from termux-* scripts -->
        <receiver
            android:name=".TermuxApiReceiver"
            android:exported="true">
            <intent-filter>
                <action android:name="com.termux.api.API_CALL" />
            </intent-filter>
        </receiver>

        <!-- TermuxOpenReceiver - MUST be at .app.TermuxOpenReceiver to match real Termux -->
        <receiver
            android:name=".app.TermuxOpenReceiver"
            android:exported="false">
        </receiver>

        <!-- BootReceiver - Run scripts on device boot (like Termux:Boot) -->
        <receiver
            android:name=".boot.BootReceiver"
            android:enabled="true"
            android:exported="true"
            android:directBootAware="false"
            android:permission="android.permission.RECEIVE_BOOT_COMPLETED">
            <intent-filter>
                <action android:name="android.intent.action.BOOT_COMPLETED" />
            </intent-filter>
        </receiver>

        <!-- ============================================ -->
        <!-- SERVICES -->
        <!-- ============================================ -->

        <!-- TermuxService - CRITICAL for background operation and wake lock -->
        <service
            android:name=".app.TermuxService"
            android:exported="false"
            android:foregroundServiceType="specialUse">
            <property
                android:name="android.app.PROPERTY_SPECIAL_USE_FGS_SUBTYPE"
                android:value="terminal_session" />
        </service>

        <!-- RunCommandService - For external command execution (like Tasker) -->
        <service
            android:name=".app.RunCommandService"
            android:exported="true"
            android:permission="com.termux.permission.RUN_COMMAND">
            <intent-filter>
                <action android:name="com.termux.RUN_COMMAND" />
            </intent-filter>
        </service>

        <!-- SetupService - Foreground service for download reliability -->
        <service
            android:name=".SetupService"
            android:exported="false"
            android:foregroundServiceType="dataSync" />

        <!-- ============================================ -->
        <!-- SAMSUNG / VENDOR SPECIFIC METADATA -->
        <!-- ============================================ -->
        <meta-data
            android:name="android.max_aspect"
            android:value="2.4" />
        <meta-data
            android:name="com.samsung.android.keepalive.density"
            android:value="true" />
        <meta-data
            android:name="com.samsung.android.multidisplay.keep_process_alive"
            android:value="true" />
        <meta-data
            android:name="com.sec.android.support.multiwindow"
            android:value="true" />

    </application>

</manifest>
